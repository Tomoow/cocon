---
/**
 * ExpertisesCarousel: SectionHeading + 6 cards.
 * Desktop (lg): grid 3 cols, 2 rows. Tablet/mobile: 1 row, scroll-snap, indicator "X van Y" + ellipse arrow buttons; drag to swipe.
 */
import SectionHeading from './SectionHeading.astro';
import InfoCard from './InfoCard.astro';

import type { ImageMetadata } from 'astro';

export interface CardData {
  imageSrc: ImageMetadata;
  imageAlt: string;
  number: string;
  title: string;
  description: string;
  backBullets: string[];
}

interface Props {
  cards: CardData[];
  class?: string;
}

const { cards, class: className } = Astro.props;
---

<section class:list={['expertises-section', className]} aria-labelledby="expertise-heading" data-expertises-carousel>
  <SectionHeading
    id="expertise-heading"
    title="Gespecialiseerde zorg voor elke fase"
    subtitle="Ontdek onze expertises"
  />

  <!-- Desktop: grid 3 cols, all 6 visible -->
  <div class="expertises-grid">
    {cards.map((card) => (
      <InfoCard
        imageSrc={card.imageSrc}
        imageAlt={card.imageAlt}
        number={card.number}
        title={card.title}
        description={card.description}
        backBullets={card.backBullets}
      />
    ))}
  </div>

  <!-- Tablet/mobile: pagination + arrows + scrollable track -->
  <div class="expertises-carousel">
    <div class="expertises-carousel__bar">
      <span class="expertises-carousel__indicator" aria-live="polite" data-carousel-indicator>Pagina 1 van 6</span>
      <div class="expertises-carousel__arrows">
        <button type="button" class="expertises-carousel__arrow" data-carousel-prev aria-label="Vorige kaart">
          <span class="expertises-carousel__arrow-inner" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </span>
        </button>
        <button type="button" class="expertises-carousel__arrow" data-carousel-next aria-label="Volgende kaart">
          <span class="expertises-carousel__arrow-inner" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
          </span>
        </button>
      </div>
    </div>
    <div class="expertises-carousel__track" data-carousel-track>
      {cards.map((card) => (
        <div class="expertises-carousel__slide">
          <InfoCard
            imageSrc={card.imageSrc}
            imageAlt={card.imageAlt}
            number={card.number}
            title={card.title}
            description={card.description}
            backBullets={card.backBullets}
          />
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .expertises-section {
    position: relative;
    overflow: visible;
  }

  /* Desktop: grid visible from lg; cards stretch to same height per row */
  .expertises-grid {
    display: none;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem; /* 24px */
    align-items: stretch;
  }

  /* Card fills grid cell: flex chain so inner/front/body grow and "Meer info" stays at bottom */
  /* :global() needed so selectors match InfoCard's elements (they have InfoCard's scope, not this component's) */
  .expertises-grid :global(.info-card) {
    display: flex;
    flex-direction: column;
    min-height: 0;
    height: 100%;
  }

  .expertises-grid :global(.info-card .info-card__inner) {
    flex: 1;
    min-height: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .expertises-grid :global(.info-card .info-card__front) {
    flex: 1;
    min-height: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  @media (min-width: 1200px) {
    .expertises-grid {
      display: grid;
    }
    .expertises-carousel {
      display: none !important;
    }
  }

  /* Carousel: visible below lg */
  .expertises-carousel {
  }

  @media (min-width: 1200px) {
    .expertises-carousel {
      display: none;
    }
  }

  .expertises-carousel__bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .expertises-carousel__indicator {
    font-family: 'Raleway', sans-serif;
    font-size: 1rem;
    color: var(--color-text-secondary);
  }

  .expertises-carousel__arrows {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Ellipse arrow buttons (same style as IconButton) */
  .expertises-carousel__arrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.75rem;
    padding: 0;
    border: none;
    background: var(--color-background-muted);
    color: var(--color-primary);
    border-radius: 50%;
    transform: rotate(45deg);
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .expertises-carousel__arrow:hover {
    opacity: 0.85;
  }

  .expertises-carousel__arrow:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .expertises-carousel__arrow-inner {
    display: flex;
    transform: rotate(-45deg);
  }

  .expertises-carousel__track {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    gap: 1.5rem; /* 24px */
    padding-bottom: 1rem;
    padding-top: 2rem;
  }

  /* Slide width so visible cards + gaps fill 100% (no gap on outer edges) */
  .expertises-carousel__slide {
    flex: 0 0 100%;
    scroll-snap-align: start;
    min-width: 0;
  }

  @media (min-width: 768px) {
    /* 2 cards + 1 gap = 100% */
    .expertises-carousel__slide {
      flex: 0 0 calc((100% - 1.5rem) / 2);
    }
  }

  @media (min-width: 1000px) {
    /* 3 cards + 2 gaps = 100% */
    .expertises-carousel__slide {
      flex: 0 0 calc((100% - 2 * 1.5rem) / 3);
    }
  }
</style>

<script>
  // Defer non-critical: Carousel navigation not needed for initial render
  (function() {
    function initExpertisesCarousel() {
    const section = document.querySelector('[data-expertises-carousel]');
    const track = section?.querySelector('[data-carousel-track]') as HTMLElement | null;
    const indicator = section?.querySelector('[data-carousel-indicator]') as HTMLElement | null;
    const prevBtn = section?.querySelector('[data-carousel-prev]') as HTMLElement | null;
    const nextBtn = section?.querySelector('[data-carousel-next]') as HTMLElement | null;
    if (!track || !indicator) return;

    const totalCards = track.querySelectorAll('.expertises-carousel__slide').length;
    const gapPx = 24; /* match gap: 1.5rem */

    function getSlides(): HTMLElement[] {
      return Array.from(track.querySelectorAll('.expertises-carousel__slide'));
    }

    /* Same breakpoints as CSS: 768px = 2 cols, 1000px = 3 cols. Ensures pagination matches visible cards. */
    function getCardsPerView(): number {
      const w = typeof window !== 'undefined' ? window.innerWidth : 1200;
      if (w >= 1000) return Math.min(3, totalCards);
      if (w >= 768) return Math.min(2, totalCards);
      return 1;
    }

    function getTotalPages(): number {
      const n = getCardsPerView();
      return Math.ceil(totalCards / n);
    }

    function getCurrentPage(): number {
      const slides = getSlides();
      if (slides.length === 0) return 1;
      const scrollLeft = track.scrollLeft;
      const totalPages = getTotalPages();
      const cardsPerView = getCardsPerView();
      const step = slides[0].offsetWidth + gapPx;
      const pageWidth = cardsPerView * step;
      const page = Math.round(scrollLeft / pageWidth) + 1;
      return Math.max(1, Math.min(totalPages, page));
    }

    function updateIndicator() {
      const total = getTotalPages();
      const page = getCurrentPage();
      indicator.textContent = `Pagina ${page} van ${total}`;
    }

    function go(direction: 1 | -1) {
      const slides = getSlides();
      if (slides.length === 0) return;
      const cardsPerView = getCardsPerView();
      const totalPages = getTotalPages();
      const currentPage = getCurrentPage();
      const targetPage = Math.max(1, Math.min(totalPages, currentPage + direction));
      const step = slides[0].offsetWidth + gapPx;
      const targetScroll = (targetPage - 1) * cardsPerView * step;
      track.scrollTo({ left: targetScroll, behavior: 'smooth' });
    }

    let scrollTimeout: ReturnType<typeof setTimeout> | null = null;
    track.addEventListener('scroll', () => {
      if (scrollTimeout) clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateIndicator, 50);
    });
    window.addEventListener('resize', () => {
      if (scrollTimeout) clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateIndicator, 100);
    });
    prevBtn?.addEventListener('click', () => go(-1));
    nextBtn?.addEventListener('click', () => go(1));

    let touchStartX = 0;
    let touchEndX = 0;
    track.addEventListener('touchstart', (e: TouchEvent) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    track.addEventListener('touchend', (e: TouchEvent) => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) go(diff > 0 ? 1 : -1);
    }, { passive: true });

    updateIndicator();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initExpertisesCarousel);
    } else {
      setTimeout(initExpertisesCarousel, 0);
    }
  })();
</script>
